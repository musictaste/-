# 内存管理
[TOC]


主要内容：进程到内存空间的映射过程

是入门课程，后续的课程由周老师讲IO


### 内存管理的发展历程

#### **DOS时代 - 同一时间只能有一个进程在运行（也有一些特殊算法可以支持多进程）**

#### **windows9x - 多个进程装入内存 1：内存不够用 2：互相打扰，不小心访问到别人的空间**

#### 为了解决这两个问题，诞生了==现在的内存管理系统：虚拟地址 分页装入 软硬件结合寻址（由操作系统和MMU相互配合）==

![403](58909704204044D8AB7B18F819A73F30)

#### 1. ==分页==（内存不够用，内存撑爆）

内存中分成固定大小的页框（4K），把程序（硬盘上）分成4K大小的块，用到哪一块，加载那一块，加载的过程中，如果内存已经满了，会把最不常用的一块放到swap分区（交换分区，硬盘实现）， 把最新的一块加载进来，这个就是著名的LRU算法

> 1. LRU算法 LeetCode146题，头条要求手撕，阿里去年也要求手撕
> 2. Least Recently Used 最不常用
> 3. 哈希表（保证 查找操作O(1)） + 链表 （保证 排序操作和新增操作 O(1)））
> 4. 双向链表 （保证 左边指针 指向右边块）
> 
> 所有涉及到缓存的问题，都涉及到LRU、LFU算法

#### 作业：LRU算法 leetcode146题

##### 方案一：数组：+时间戳，因为要遍历数组得到时间差最大的值，需要遍历整个数组，时间复杂度为O(n)

#####  方案二：单向链表：每使用一次，在链表的尾节点加入节点，那么最不常用的节点就是头节点；查找节点的时间复杂度为O(n)、移动节点的时间复杂度都为O(1)

##### 方案三：hash表+链表，linkedHashMap

    当左边指针指向右边的节点时，需要重新遍历整个链表，导致时间复杂度为O(n) 
    
##### 方案四：hash表+双向链表
 
允许使用hashmap，不允许使用linkedhashmap


---

==头条的算法题，要求在15分钟之内写在纸上，并且还能运行==

==头条算法面试题：岛问题==

==leetcode刷题，先从简单开始刷，刷到中等就可以了==

==补充课程：数据结构和算法==

#### 2. 虚拟内存（解决相互打扰问题）

![404](A051B660ED9247D5A07B91B923C8282D)
![405](9DF91D431BD54450BCFB5EA2D26B3BCA)
![406](04D878DB2A124947ACB40A8A50DD83DF)

注：物理空间=内存+磁盘（Swap交换空间）

##### 为什么使用虚拟内存? 隔离应用程序+安全

    1.隔离应用程序
        每个程序都认为自己又连续可用的内存
        突破物理内存限制
        应用程序不需要考虑物理内存是否够用
    2.安全
        保护物理内存，不被恶意程序访问


> 1.DOS Win31 ... 互相干掉
>
> 2.为了保证互不影响 - 让进程工作在虚拟空间，程序中用到的空间地址不再是直接的物理地址，而是虚拟的地址，这样，A进程永远不可能访问到B进程的空间
> 3. 虚拟空间多大呢？寻址空间 - 64位系统 2 ^ 64，比物理空间大很多 ，单位是byte
> 4. 站在虚拟的角度，进程是独享整个系统 + CPU（每一个进程都虚拟的独占整个CPU）
> 5. 内存映射：偏移量 + 段的基地址 = 线性地址 （虚拟空间）
> 6. 线性地址通过 OS + MMU（硬件 Memory Management Unit 内存管理单元）

##### 虚拟空间的格式是固定的：

    只读的代码和数据
    可读写的数据
    运行时堆
    共享库
    

#### 3. 缺页中断（不是很重要）：

> 1.需要用到的页面，内存中没有，产生缺页异常（中断），由内核处理并加载
 

### ZGC

![407](7DCEBDC0A4114095B681E7AA942A281C)

Colored Pointer + Load Barrier

算法叫做：Colored Pointer

**GC信息记录在指针上，不是记录在头部**，好处：immediate memory use**内存立即重用，效率马上提升**

**不支持32位，不支持指针压缩，不支持windows系统，只支持linux系统**

load Barrier根据指针颜色决定是否做一些事情

**42位指针（代表对象的地址） 寻址空间4T JDK13扩展成16T 目前为止最大16T 2^44**



### CPU如何区分一个立即数 和 一条指令 ？？

**总线内部分为：数据总线 地址总线 控制总线**

### ==地址总线目前：48位（主板产商为了省成本），4位给颜色指针了，剩下可用的只有44位，也就是16T==

==颜色指针本质上包含了地址映射的概念==

现在已经很难出现内存碎片的问题

